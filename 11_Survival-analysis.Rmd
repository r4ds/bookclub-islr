# Survival Analysis and Censored Data

**Learning objectives:**

- Describe how **censored data** impacts survival analysis.
- Calculate a **Kaplan-Meier survival curve.**
- Compare the survival rates of two groups with the **log-rank test.**
- Model survival data using **Cox's proportional hazards**
- Cox model assumptions
- Apply **shrinkage methods** to regularize the Cox model.
- Calculate the generalized **AUC** for a survival model.

```{r 11load_libraries, echo = FALSE, message=FALSE}
library(ISLR2)
library(survival)
library(dplyr)
```

## What is survival (censored) data?

![Source: https://www.reddit.com/r/statisticsmemes/comments/u21swt/what_i_learned_in_survival_analysis_so_far/](images/survival_analysis_meme.jpg)

Time-to-event data that consist of a distinct start time and end time

Examples:

- Time from surgery to death

- Time for customer to cancel a subscription (churn)

- Time to machine malfunction

![Source: https://towardsdatascience.com/introduction-to-survival-analysis-6f7e19c31d96](images/time_to_event.png)

## Aliases for survival analysis

Survival analysis is common in many other fields, such as:

- Reliability analysis

- Duration analysis

- Event history analysis

- Time-to-event analysis

## Introduction to Survival Analysis (zedstatistics) ---

`r knitr::include_url("https://www.youtube.com/embed/v1QqpG0rR1k")`

## Types of censoring

Observations are __censored__ when the information about their survival time is incomplete.

Examples:

- Loss to follow-up

- Withdrawal from study

- No event/outcome by end of fixed study period

These are examples of **right** censoring.

Left censoring and interval censoring are also possible, but the most frequent is right censoring.

Due to censoring, we don't actually observe the time T of the event (e.g. 'death') but rather a variable $Y$:

$$ Y = min(T,C)$$

where C is the time of censoring.  We also need to observe a status indicator:

$$ \delta = 
             \left\{ \begin{array}{c l}
                1, & \text{if } T \leq C \\
                0, & \text{if } T > C
            \end{array} \right.
$$

These together as pairs $(y_n, \delta_n)$ represent the survival data. (In R, they are combined to make a survival object using `Surv`)


## Lab: Survival Analysis

Rather then do the lab at the end, let's try a different approach and thread it through the chapter discussion.

Hopefully this helps illustrate the main points of the text with examples worked out in R. 

We begin with the `BrainCancer` data set, which is part of the  `ISLR2` package.

```{r 11dataset}
data("BrainCancer")
dim(BrainCancer)
head(BrainCancer)
```

The rows index the 88 patients, while the columns contain the 8 predictors.

```{r 11count}
BrainCancer %>% 
     count(status)
```


Before beginning an analysis, it is important to know how the `status` variable has been coded.  Most software, including `R`, uses the convention that `status = 1` indicates an uncensored observation,  and `status = 0` indicates a censored observation. But some scientists might use the opposite coding. For the `BrainCancer` data set $35$ patients died before the end of the study.


## Kaplan-Meier survival curve

The survival function / curve:

$$
S(t) = Pr(T>t)
$$

Here T is the time of 'death' or whatever is being considered, and $S(t)$ is the probability of surviving up to time t.  

We can't directly use our data because we do not observe T!  However, consider instead the instantaneous rate of death at time $t$, this is something we might be able to estimate since it only depends on the number patients 'at risk' at that moment and how many of them die 'at' that moment.  This is the basic idea behind the construction on page  465 for estimating the survival curve directly from the data. 


## Kaplan-Meier survival curve in R

To begin the analysis, we re-create  the Kaplan-Meier survival curve  shown in  Figure 11.2, using the `survfit()` function within the `R` `survival` library. Here `time` corresponds to $y_i$, the time to the $i$th event (either censoring or death).

```{r 11plot_KM_curve}
fit.surv <- survfit(Surv(time, status) ~ 1, data = BrainCancer)
plot(fit.surv, xlab = "Months",
    ylab = "Estimated Probability of Survival")
```

## KM curve stratified by sex

Next we create Kaplan-Meier survival curves that are stratified by `sex`, in order to reproduce Figure 11.3.

```{r 11KM_curve_sex}
fit.sex <- survfit(Surv(time, status) ~ sex, data = BrainCancer)
plot(fit.sex, xlab = "Months",
    ylab = "Estimated Probability of Survival", col = c(2,4))
legend("bottomleft", levels(BrainCancer$sex), col = c(2,4), lty = 1)
```

## Log-Rank test

As discussed in Section 11.4, we can perform a log-rank test to compare the survival of males to females, using the `survdiff()` function.

```{r 11logrank_test}
logrank.test <- survdiff(Surv(time, status) ~ sex, data = BrainCancer)
logrank.test
```

The resulting $p$-value is $0.23$, indicating  no evidence of a difference in survival between the two sexes.


## Survminer package

- Survminer is a package that draws survival curves using ggplot, and can provide logrank p-values all in one go!

Using `survminer` package
```{r 11survminer, message=FALSE}
library(survminer)
ggsurvplot(fit.sex, data = BrainCancer, 
           pval = TRUE,
           conf.int = TRUE, 
           risk.table = TRUE, 
           legend.title = "Sex", 
           legend.labs = c("Female", "Male"))
```



## Hazard Function

The hazard function (11.9) is defined at a given moment *t* in time, the potential risk of having an event given you survived up to time *t*.

$$h(t) = lim_{\Delta t \to 0}  \frac{ Pr(t+ \Delta t \geq T > t | T > t)}{\Delta t}$$


Itâ€™s important to note here that the hazard is **not a probability** because we are dividing the probability by a time interval. Instead what we get is a rate. And since we are dealing with the condition of survival up to time t, this is why sometimes the hazard function is referred to as conditional failure rate.

Why do we care about the hazard function? It turns out that a key approach for modeling survival data as a function of covariates (i.e., regressors) relies heavily on the hazard function.

How is the hazard rate related to the survival probability? It seems that the rate of death should be related to the rate of change of 'survival' in some way. Lets try this:

$$
\begin{align}
\frac{d S}{d t} &= lim_{\Delta t \to 0} \frac{S(t+dt) - S(t)}{\Delta t} \\
& = lim_{\Delta t \to 0}  \frac{Pr(T>t+\Delta t) - Pr(T > t)}{\Delta t}\\
& = lim_{\Delta t \to 0}  \frac{Pr(T>t+\Delta t) - (Pr(T > t + \Delta t) + Pr(t+ \Delta t \geq T > t))}{\Delta t} \\
& = lim_{\Delta t \to 0}  \frac{- Pr(t+ \Delta t \geq T > t)}{\Delta t} \\
& = - f(t)  \text{  see book eqn 11.11}
\end{align}
$$

$f(t)$ is the instantaneous death rate, close to what we want..  But we can relate $f(t)$ to $h(t)$ and $S(t)$ using Baye's rule:

$$
\begin{align}
h(t) &= lim_{\Delta t \to 0}  \frac{ Pr(t+ \Delta t \geq T > t | T > t)}{\Delta t} \\
&=lim_{\Delta t \to 0}  \frac{ Pr((t+ \Delta t \geq T > t) \cap (T > t))/\Delta t}{P(T>t)} \\
&=lim_{\Delta t \to 0}  \frac{ Pr(t+ \Delta t \geq T > t)/\Delta t}{S(t)}\\
&= \frac{ f(t)}{S(t)}
\end{align}
$$
 
So we have finally:

$$
\frac{d S}{d t} = - S(t)h(t)
$$

or 

$$
\frac{d \text{ ln} S}{d t} = -h(t)
$$

so that the survival probability is the exponential of the 'cumulative' hazard:

$$
S = exp(-\int{h(t) dt})
$$

Note that the exponential of a sum is the same as the product of exponentials, so that this construction is structurally similar to that on page 465.

## Cumulative Hazard Function

![Source: https://tinyheero.github.io/2016/05/12/survival-analysis.html](images/cum_hazard_function.png)

Let's plot the cumulative hazard for the Brain cancer dataset with sex as covariate
```{r 11cum_hazard_plot}
ggsurvplot(fit.sex, 
           data = BrainCancer, 
           conf.int = TRUE, 
           risk.table.col = "strata", 
           legend.title = "Sex", 
           legend.labs = c("Female", "Male"), 
           fun = "cumhaz")
```

## Proportional Hazards

The *proportional hazards assumption* states that

![Source: ISLR2 (11.14)](images/prop_hazard.png)

It is important to emphasize that the relative risk does not depend on time, i.e. it is constant in time for the same pair of values of any feature, so hazards are proportional independent of time.

We can use some specific distribution for the baseline survival or hazard function â€“ and then we get a **parametric PH model**, or do not make such assumptions about the baseline functions â€“ and then get a **semi-parametric PH model**, often called a Cox PH model after its author.

## Regression Models

### Cox Proportional Hazards-Hazards Model

The **Cox proportional-hazards model (Cox, 1972)** is essentially a regression model commonly used statistical in medical research for investigating the association between the survival time of patients and one or more predictor variables.

The purpose of the model is to evaluate simultaneously the effect of several factors on survival. In other words, it allows us to examine how specified factors influence the rate of a particular event happening (e.g., infection, death) at a particular point in time. This rate is commonly referred as the hazard rate. Predictor variables (or factors) are usually termed *covariates* in the survival-analysis literature.

Let's fit the Cox proportional hazards models using the `coxph()`  function.
To begin, we consider a model that uses `sex` as the only predictor.
```{r 11coxph}
fit.cox <- coxph(Surv(time, status) ~ sex, data = BrainCancer)
summary(fit.cox)
```

Regardless of which test we use, we see that there is no clear evidence for a difference in survival between males and females.

Let's run the Cox PH model with all covariates.
```{r 11coxph_all}
fit_all_cox <- coxph(Surv(time, status) ~ ., data = BrainCancer)
summary(fit_all_cox)
```

## Visualizing the estimated distribution of survival times

Having fit a Cox model to the data, itâ€™s possible to visualize the predicted survival proportion at any given point in time for a particular risk group. The function survfit() estimates the survival proportion, by default at the mean values of covariates.
```{r 11coxph_viz}
# plot the baseline survival function
ggsurvplot(survfit(fit_all_cox), data = BrainCancer, palette = "#2E9FDF",
           ggtheme = theme_minimal())
```

Let's plot the Cox Proportional Hazards covariates coefficients estimates/CI
```{r 11coxph_coef}
library(ggstatsplot)
ggcoefstats(fit_all_cox, 
            title = "Cox PH Model Covariates Coefficients Estimates/CI"
            )
```

## Cox Model Assumptions

The Cox proportional hazards model makes several assumptions. Thus, it is important to assess whether a fitted Cox regression model adequately describes the data.

Here, weâ€™ll discuss three types of diagnostics for the Cox model:

- Testing the proportional hazards assumption.

- Examining influential observations (or outliers).

- Detecting nonlinearity in relationship between the log hazard and the covariates.

## Testing proportional Hazard assumptions

The proportional hazards (PH) assumption can be checked using statistical tests and graphical diagnostics based on the *scaled Schoenfeld residuals*.

In principle, the *Schoenfeld residuals* are independent of time. A plot that shows a non-random pattern against time is evidence of violation of the PH assumption.
```{r 11coxtest_1}
test.ph <- cox.zph(fit_all_cox)
test.ph
```

Itâ€™s possible to do a graphical diagnostic using the function *ggcoxzph()* [in the `survminer` package], which produces, for each covariate, graphs of the scaled Schoenfeld residuals against the transformed time.
```{r 11coxtest_2}
ggcoxzph(test.ph)
```

From the graphical inspection, there is no pattern with time. The assumption of proportional hazards appears to be supported for the model covariates.

## Testing influential observations

To test influential observations or outliers, we can visualize either:

- the deviance residuals or

- the dfbeta values

The function *ggcoxdiagnostics()* [in `survminer` package] provides a convenient solution for checking influential observations.
```{r 11cox_diag_dfbeta}
ggcoxdiagnostics(fit_all_cox, type = "dfbeta", linear.predictions = FALSE, ggtheme = theme_bw())
```

Itâ€™s also possible to check outliers by visualizing the deviance residuals. The deviance residual is a normalized transform of the martingale residual. These residuals should be roughly symmetrically distributed about zero with a standard deviation of 1.

- Positive values correspond to individuals that â€œdied too soonâ€ compared to expected survival times.

- Negative values correspond to individual that â€œlived too longâ€.

- Very large or small values are outliers, which are poorly predicted by the model.

```{r 11cox_diag_deviance}
ggcoxdiagnostics(fit_all_cox, type = "deviance", linear.predictions = FALSE, ggtheme = theme_bw())
```

The pattern looks fairly symmetric around 0.

Testing non linearity

Often, we assume that continuous covariates have a linear form. However, this assumption should be checked.

Plotting the *Martingale residuals* against continuous covariates is a common approach used to detect *nonlinearity* or, in other words, to assess the functional form of a covariate. For a given continuous covariate, patterns in the plot may suggest that the variable is not properly fit.

Nonlinearity is not an issue for categorical variables, so we only examine plots of martingale residuals and partial residuals against a continuous variable.

Martingale residuals may present any value in the range (-INF, +1):

- A value of martinguale residuals near 1 represents individuals that â€œdied too soonâ€,

- and large negative values correspond to individuals that â€œlived too longâ€.

To assess the functional form of a continuous variable in a Cox proportional hazards model, weâ€™ll use the function *ggcoxfunctional()* [in the `survminer` R package].

The covariates must be numerical.

To test `sex`, it is necessary to convert the covariate to numerical.
```{r 11cox_functional_1}
BC_sex <- BrainCancer %>% 
     mutate(sex = sex %>% as.numeric())

ggcoxfunctional(Surv(time, status) ~ sex + log(sex) + sqrt(sex), data = BC_sex)
```

The function *ggcoxfunctional()* displays graphs of continuous covariates against martingale residuals of null cox proportional hazards model. This might help to properly choose the functional form of continuous variable in the Cox model. Fitted lines with lowess function should be **linear** to satisfy the Cox proportional hazards model assumptions.  Inthis case, the covariate `sex` passes the test.

Let's test `gtv`
```{r 11cox_functional_2}
ggcoxfunctional(Surv(time, status) ~ gtv + log(gtv) + sqrt(gtv), data = BrainCancer)
```

From the plot, the covariate `gtv` exhibits a nonlinear pattern.

## Meeting Videos

### Cohort 1

`r knitr::include_url("https://www.youtube.com/embed/VyjPLYLwBMg")`

<details>
<summary> Meeting chat log </summary>

```
00:30:47	Jon Harmon (jonthegeek):	ggplot2 default red is "salmon" (according to this site: https://www.htmlcsscolor.com/hex/F8766D)

the default blue is  "cornflower blue" https://www.htmlcsscolor.com/hex/619CFF

and while I'm at it, the default green is "dark pastel green" https://www.htmlcsscolor.com/hex/00BA38
00:55:24	Jon Harmon (jonthegeek):	summand == addend https://www.merriam-webster.com/dictionary/summand
00:55:54	Jon Harmon (jonthegeek):	subtrahend
00:56:31	Jon Harmon (jonthegeek):	https://www.merriam-webster.com/dictionary/subtrahend

A subtrahend is subtracted from a minuend.

https://www.merriam-webster.com/dictionary/minuend
00:57:29	Jonathan.Bratt:	ðŸ˜„
01:05:55	Federica Gazzelloni:	workshop: https://bioconnector.github.io/workshops/r-survival.html
01:06:29	Jon Harmon (jonthegeek):	There's an in-progress survival analysis package in tidymodels, btw: https://github.com/tidymodels/censored/
```
</details>

`r knitr::include_url("https://www.youtube.com/embed/dbIg-JyWn8U")`

<details>
<summary> Meeting chat log </summary>

```
00:27:56	Jon Harmon (jonthegeek):	https://github.com/tidymodels/censored/ not yet on CRAN
00:50:52	Jon Harmon (jonthegeek):	https://twitter.com/justsaysrisks
```
</details>

### Cohort 2

`r knitr::include_url("https://www.youtube.com/embed/8JhVCWNVpyw")`

<details>
<summary> Meeting chat log </summary>

```
00:27:58	Jim Gruman:	+1 zed stats is excellent
00:28:55	Ricardo Serrano:	https://youtu.be/v1QqpG0rR1k
00:37:00	Ricardo Serrano:	https://sphweb.bumc.bu.edu/otlt/MPH-Modules/BS/BS704_Survival/BS704_Survival5.html
00:41:06	Jim Gruman:	ðŸ§Ÿ   The ggfortify package also contains methods for autoplotting simple km plots.
00:50:26	Jim Gruman:	Hannah Frick's recent post on survival in tidymodels: https://www.tidyverse.org/blog/2021/11/survival-analysis-parsnip-adjacent/
00:58:55	Jim Gruman:	Emily Zabor's intro guide is also a nice supplement to the ISLR survival chapter https://www.emilyzabor.com/tutorials/survival_analysis_in_r_tutorial.html#Part_1:_Introduction_to_Survival_Analysis
01:06:52	Jim Gruman:	thank you Ricardo!
```
</details>

`r knitr::include_url("https://www.youtube.com/embed/EdNBZVNSXyA")`

<details>
<summary> Meeting chat log </summary>

```
00:14:15	Ricardo Serrano:	https://github.com/rserran/survival_analysis
00:14:26	Federica Gazzelloni:	thank you!
00:58:33	Jim Gruman:	yes
00:59:38	Federica Gazzelloni:	let's talk on slack
00:59:56	Jim Gruman:	see you all on slack
```
</details>

### Cohort 3

`r knitr::include_url("https://www.youtube.com/embed/Ivl1tOWOfEM")`

<details>
<summary> Meeting chat log </summary>

```
00:01:30	Mei Ling Soh:	https://www.youtube.com/watch?v=AsNTP8Kwu80&vl=en
00:02:57	Mei Ling Soh:	https://www.rstudio.com/blog/torch/
00:05:11	Mei Ling Soh:	https://rstudio.github.io/reticulate/
00:54:05	Fariborz Soroush:	No question here :D
```
</details>

`r knitr::include_url("https://www.youtube.com/embed/ONEtOcZMoZY")`

<details>
<summary> Meeting chat log </summary>

```
00:51:05	Nilay YÃ¶net:	https://hastie.su.domains/ISLR2/Labs/Rmarkdown_Notebooks/Ch11-surv-lab.html
00:51:14	Nilay YÃ¶net:	https://bioconnector.github.io/workshops/handouts/r-survival-cheatsheet.pdf
00:51:31	Nilay YÃ¶net:	https://bioconnector.github.io/workshops/r-survival.html#survival_curves
```
</details>

### Cohort 4

`r knitr::include_url("https://www.youtube.com/embed/URL")`

<details>
<summary> Meeting chat log </summary>

```
ADD LOG HERE
```
</details>
